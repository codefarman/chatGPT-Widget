<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>AI MBA Counselor</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap">
<style>
:root{
  --bg: #f8f9fc;
  --chat-bg: #ffffff;
  --user-bg: #0b76ff;
  --bot-bg: #f1f3f5;
  --accent: #0b76ff;
  --text: #1e293b;
  --muted: #64748b;
  --radius: 16px;
  --shadow: 0 10px 30px rgba(0,0,0,0.06);
}
* { box-sizing: border-box; margin:0; padding:0; }
body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); height: 100vh; display: flex; align-items: center; justify-content: center; padding: 16px; }
.widget { width: 100%; max-width: 460px; height: 94vh; background: var(--chat-bg); border-radius: var(--radius); box-shadow: var(--shadow); display: flex; flex-direction: column; overflow: hidden; border: 1px solid #e2e8f0; }

/* Header - ChatGPT Style */
.header { padding: 14px 20px; border-bottom: 1px solid #e2e8f0; background: var(--chat-bg); text-align: center; font-weight: 600; font-size: 17px; position: relative; }
/* .header::before { content: ''; position: absolute; left: 50%; top: 50%; transform: translate(-50%,-50%); width: 36px; height: 36px; background: linear-gradient(135deg,#0b76ff,#00c2ff); border-radius: 10px; } */
.close-btn { position: absolute; right: 16px; top: 50%; transform: translateY(-50%); background:none; border:none; font-size:24px; cursor:pointer; color:#94a3b8; }

/* Messages */
.messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 18px; }
.msg { max-width: 86%; line-height: 1.5; padding: 12px 16px; border-radius: 16px; animation: fadeIn 0.3s ease; font-size: 15px; }
.msg.user { align-self: flex-end; background: var(--user-bg); color: white; border-bottom-right-radius: 4px; }
.msg.bot { align-self: flex-start; background: var(--bot-bg); border-bottom-left-radius: 4px; }

/* Markdown & Lists */
.msg.bot p { margin: 8px 0; }
.msg.bot ul, .msg.bot ol { margin: 10px 0; padding-left: 20px; }
.msg.bot strong { font-weight: 600; }

/* Tiles / Cards */
.tile { background: white; border: 1px solid #e2e8f0; border-radius: 14px; padding: 16px; margin: 12px 0; box-shadow: 0 4px 12px rgba(0,0,0,0.04); transition: all 0.2s; cursor: pointer; }
.tile:hover { transform: translateY(-4px); box-shadow: 0 12px 30px rgba(0,0,0,0.1); }
.tile-title { font-weight: 600; font-size: 16px; margin-bottom: 6px; }
.tile-subtitle { font-size: 13px; color: var(--muted); margin-bottom: 10px; }
.tile-tags { display: flex; flex-wrap: wrap; gap: 6px; margin: 10px 0; }
.tag { background: #e0f2fe; color: #0369a1; padding: 4px 10px; border-radius: 999px; font-size: 11px; font-weight: 500; }
.tile-action { margin-top: 12px; padding: 10px 16px; background: var(--accent); color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; width: 100%; }

/* Chips */
.chips-area { padding: 12px 20px; display: flex; flex-wrap: wrap; gap: 10px; background: var(--chat-bg); border-top: 1px solid #e2e8f0; }
.chip { padding: 10px 16px; background: #f1f5f9; border-radius: 999px; font-size: 14px; cursor: pointer; transition: all 0.2s; }
.chip:hover { background: #e2e8f0; }
.chip.primary { background: var(--accent); color: white; }

/* Input */
.input-area { padding: 16px 20px; background: var(--chat-bg); border-top: 1px solid #e2e8f0; display: flex; gap: 12px; align-items: center; }
#inputField { flex: 1; padding: 14px 18px; border: 1px solid #cbd5e1; border-radius: 12px; font-size: 15px; outline: none; }
#inputField:focus { border-color: var(--accent); }
#sendBtn { background: var(--accent); color: white; border: none; width: 44px; height: 44px; border-radius: 50%; cursor: pointer; font-size: 18px; }

/* Typing & Animations */
.typing { display: inline-flex; gap: 4px; align-items: center; }
.dot { width: 8px; height: 8px; background: #94a3b8; border-radius: 50%; animation: blink 1.4s infinite both; }
.dot:nth-child(2) { animation-delay: 0.2s; }
.dot:nth-child(3) { animation-delay: 0.4s; }
@keyframes blink { 0%,80%,100% { opacity: 0.3; transform: scale(0.8); } 40% { opacity: 1; transform: scale(1); } }
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: none; } }

/* Modal */
.modal-back { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 100; }
.modal { background: white; width: 90%; max-width: 400px; border-radius: 16px; padding: 24px; text-align: center; box-shadow: var(--shadow); }
.modal input { width: 100%; padding: 14px; margin: 12px 0; border: 1px solid #cbd5e1; border-radius: 12px; font-size: 15px; }
.modal button { margin-top: 10px; padding: 12px 20px; border: none; border-radius: 12px; cursor: pointer; }
.modal .primary { background: var(--accent); color: white; font-weight: 600; }
</style>
</head>
<body>

<div class="widget">
  <div class="header">
    ChatGPT
    <!-- <button class="close-btn" id="close">Ã—</button> -->
  </div>

  <div id="messages" class="messages"></div>
  <div id="chipsArea" class="chips-area"></div>

  <div class="input-area">
    <input id="inputField" placeholder="Ask about MBA, fees, colleges..." autocomplete="off"/>
    <button id="sendBtn">â†‘</button>
  </div>
</div>

<!-- Lead Modal -->
<div id="leadModal" class="modal-back">
  <div class="modal">
    <h3>ðŸŽ‰ Get Your Shortlist on WhatsApp</h3>
    <p style="color:#64748b;margin:12px 0;font-size:14px;">Our counselor will call you in <5 mins</p>
    <input id="leadName" placeholder="Your Name"/>
    <input id="leadPhone" placeholder="WhatsApp Number" inputmode="numeric"/>
    <div>
      <button onclick="closeLeadModal()">Cancel</button>
      <button class="primary" id="leadSubmit">Send Now</button>
    </div>
  </div>
</div>

<script>
// Config
const BACKEND_URL = "https://chatgpt-widget.onrender.com";
const CHAT_URL = BACKEND_URL + "/chat";
const LEAD_URL = BACKEND_URL + "/lead";
const STORAGE_KEY = "mba_chat_v2";

let messages = [];
let awaiting = false;
let lastIntent = null;

const msgs = document.getElementById("messages");
const chipsArea = document.getElementById("chipsArea");
const inputField = document.getElementById("inputField");
const sendBtn = document.getElementById("sendBtn");

function appendUser(text) {
  const div = document.createElement("div");
  div.className = "msg user";
  div.innerHTML = escapeHtml(text);
  msgs.appendChild(div);
  scrollToBottom();
}

function appendBot(html) {
  const div = document.createElement("div");
  div.className = "msg bot";
  div.innerHTML = html;
  msgs.appendChild(div);
  scrollToBottom();
}

function renderTiles(tiles) {
  tiles.forEach(tile => {
    const t = document.createElement("div");
    t.className = "tile";
    t.innerHTML = `
      <div class="tile-title">${tile.title || tile.name}</div>
      <div class="tile-subtitle">${tile.subtitle || ''}</div>
      ${tile.tags ? '<div class="tile-tags">' + tile.tags.map(tag => `<span class="tag">${tag}</span>`).join('') + '</div>' : ''}
      <button class="tile-action" onclick="handleTileAction('${tile.actionChip || 'Shortlist me'}')">${tile.actionChip || 'Shortlist me'}</button>
    `;
    msgs.appendChild(t);
  });
  scrollToBottom();
}

function renderChips(chips) {
  chipsArea.innerHTML = "";
  chips.forEach(text => {
    const chip = document.createElement("div");
    chip.className = "chip" + (/(apply|shortlist|interested)/i.test(text) ? " primary" : "");
    chip.textContent = text;
    chip.onclick = () => {
      if(/(apply|shortlist|interested)/i.test(text)) openLeadModal();
      else submit(text);
    };
    chipsArea.appendChild(chip);
  });
}

function showTyping() {
  const t = document.createElement("div");
  t.className = "msg bot";
  t.innerHTML = `<div class="typing"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>`;
  t.id = "typing";
  msgs.appendChild(t);
  scrollToBottom();
}

function removeTyping() {
  const t = document.getElementById("typing");
  if (t) t.remove();
}

function scrollToBottom() {
  msgs.scrollTop = msgs.scrollHeight;
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

async function submit(text) {
  if (awaiting || !text.trim()) return;
  const userMsg = text.trim();
  appendUser(userMsg);
  inputField.value = "";
  messages.push({ role: "user", content: userMsg });
  localStorage.setItem(STORAGE_KEY, JSON.stringify(messages));

  if (/(fee|apply|shortlist|interested|eligibility|placement)/i.test(userMsg)) lastIntent = userMsg;

  awaiting = true;
  showTyping();

  try {
    const res = await fetch(CHAT_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ messages })
    });
    const data = await res.json();
    removeTyping();

    const reply = (data.reply || "Let me help you with that.").trim();
    messages.push({ role: "assistant", content: reply });
    localStorage.setItem(STORAGE_KEY, JSON.stringify(messages));

    // Support rich tiles if backend sends them
    if (data.tiles && Array.isArray(data.tiles)) {
      renderTiles(data.tiles);
    } else {
      appendBot(reply.replace(/\n/g, '<br>'));
    }

    renderChips(data.chips || ["Top colleges", "Fees?", "Shortlist me"]);
  } catch (err) {
    removeTyping();
    appendBot("Sorry, I'm having trouble connecting. Try again.");
  } finally {
    awaiting = false;
  }
}

// Lead Modal
function openLeadModal() {
  document.getElementById("leadModal").style.display = "flex";
  document.getElementById("leadName").focus();
}
function closeLeadModal() {
  document.getElementById("leadModal").style.display = "none";
}

document.getElementById("leadSubmit").onclick = async () => {
  const name = document.getElementById("leadName").value.trim();
  const phone = document.getElementById("leadPhone").value.replace(/\D/g, "");
  if (!name || phone.length < 10) {
    alert("Please fill name & valid number");
    return;
  }
  closeLeadModal();
  appendBot("Thank you! Our counselor will contact you on WhatsApp shortly ðŸš€");
  // Send lead to your backend
  await fetch(LEAD_URL, { method: "POST", body: JSON.stringify({ name, phone, messages, lastIntent }) });
};

// Input handlers
sendBtn.onclick = () => submit(inputField.value);
inputField.addEventListener("keypress", e => { if (e.key === "Enter") submit(inputField.value); });

// Init
const saved = localStorage.getItem(STORAGE_KEY);
if (saved) {
  messages = JSON.parse(saved);
  messages.forEach(m => m.role === "user" ? appendUser(m.content) : appendBot(m.content.replace(/\n/g, '<br>')));
  renderChips(["Online MBA", "Fees?", "Shortlist me"]);
} else {
  appendBot("Hi! I'm your MBA Counselor for working professionals in India.<br>Ask anything â€” fees, colleges, eligibility...");
  renderChips(["Online MBA", "Executive MBA", "Offline MBA", "Study Abroad", "Certifications"] );
}

document.getElementById("close").onclick = () => {
  if (window.parent !== window) window.parent.postMessage({type:"close-lightbox"},"*");
};

function handleTileAction(action) {
  if (/(shortlist|apply|interested)/i.test(action)) openLeadModal();
  else submit(action);
}
</script>
</body>
</html>