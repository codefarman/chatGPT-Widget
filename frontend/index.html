<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>AI MBA Counselor â€” Smart Chat Widget</title>

<!-- Google font -->
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap">

<style>
/* ===== Root Theme ===== */
:root{
  --accent:#0b76ff;
  --accent2:#00c2ff;
  --bg:#f4f8ff;
  --card:#fff;
  --muted:#6b7280;
  --radius:16px;
  --shadow:0 18px 48px rgba(8,30,60,0.08);
  --chip-shadow:0 8px 20px rgba(11,118,255,0.12);
}

*{box-sizing:border-box}
html,body{margin:0;padding:0;font-family:Inter,system-ui;background:var(--bg);color:#081426;height:100%}
.container{display:flex;align-items:center;justify-content:center;height:100vh;padding:16px}

/* ===== Widget wrapper ===== */
.widget{
  width:100%;max-width:430px;height:94vh;
  background:linear-gradient(180deg,#fff,#f9fbff);
  border-radius:var(--radius);
  border:1px solid rgba(11,118,255,0.05);
  box-shadow:var(--shadow);
  display:flex;flex-direction:column;overflow:hidden;
}

/* ===== Header ===== */
.header{
  display:flex;align-items:center;gap:14px;
  padding:14px 18px;
  border-bottom:1px solid #eaf1ff;
  background:linear-gradient(90deg,rgba(11,118,255,0.05),transparent);
}
.logo{
  width:48px;height:48px;border-radius:12px;
  background:linear-gradient(135deg,var(--accent),var(--accent2));
  display:flex;align-items:center;justify-content:center;
  color:white;font-weight:700;font-size:18px;
  box-shadow:var(--chip-shadow);
}
.title{font-size:17px;font-weight:700}
.subtitle{font-size:12px;color:var(--muted)}

/* ===== Category Chips (Top) ===== */
.top-chips{
  display:flex;gap:10px;padding:12px 14px;
  overflow-x:auto;white-space:nowrap;
}
.cat-chip{
  flex:0 0 auto;padding:10px 16px;border-radius:999px;
  background:#fff;
  border:1px solid rgba(11,118,255,0.06);
  cursor:pointer;display:flex;align-items:center;gap:10px;
  transition:all .15s ease;font-size:14px;
}
.cat-chip:hover{transform:translateY(-3px);box-shadow:var(--chip-shadow)}
.cat-chip.active{
  background:linear-gradient(90deg,var(--accent),var(--accent2));
  color:white;border:none;
  box-shadow:0 12px 28px rgba(11,118,255,0.2);
}
.cat-icon{
  width:22px;height:22px;border-radius:6px;
  background:rgba(11,118,255,0.15);
  display:flex;align-items:center;justify-content:center;
}

/* ===== Messages ===== */
.messages{
  flex:1;overflow-y:auto;
  padding:14px 16px;display:flex;flex-direction:column;gap:14px;
}
.msg{
  max-width:78%;padding:12px 14px;
  border-radius:14px;line-height:1.35;
  box-shadow:0 2px 0 rgba(0,0,0,0.04);
}
.msg.bot{background:#f2f6fb;align-self:flex-start;border-top-left-radius:6px}
.msg.user{background:#dff9e1;align-self:flex-end;border-top-right-radius:6px}
.time{font-size:11px;margin-top:6px;color:var(--muted)}

/* ===== Sub-chips (AI Suggested Chips) ===== */
.sub-chips{
  display:flex;flex-wrap:wrap;gap:8px;
  padding:12px 14px;
  border-top:1px dashed #e5eeff;
  background:linear-gradient(180deg,transparent,rgba(11,118,255,0.04));
}
.chip{
  padding:8px 12px;background:white;border:1px solid rgba(11,118,255,0.06);
  border-radius:999px;cursor:pointer;
  box-shadow:0 6px 16px rgba(12,34,75,0.04);
  transition:all .14s ease;font-size:13px;
}
.chip:hover{transform:translateY(-3px)}
.chip.primary{
  background:var(--accent);color:white;border:none;
  box-shadow:0 12px 30px rgba(11,118,255,0.22);
}

/* ===== Footer Controls ===== */
.controls{
  display:flex;gap:10px;padding:12px;border-top:1px solid #eaf1ff;
  background:linear-gradient(180deg,#fff,#f8faff);
}
.input{flex:1;padding:10px 12px;border-radius:10px;border:1px solid #e8f2ff}
.send{
  padding:10px 18px;background:var(--accent);color:white;
  border:none;border-radius:10px;font-weight:700;
  cursor:pointer;display:flex;align-items:center;gap:6px;
}

/* ===== Lead Modal ===== */
.modal-back{
  position:fixed;inset:0;background:rgba(3,8,18,0.55);
  display:none;align-items:center;justify-content:center;z-index:50;
}
.modal{
  width:92%;max-width:420px;padding:20px;background:white;
  border-radius:12px;box-shadow:0 20px 60px rgba(8,30,60,0.3);
}
.modal .field{display:flex;flex-direction:column;gap:6px;margin-bottom:12px}
.modal input{padding:10px;border-radius:8px;border:1px solid #e8f2ff}

</style>
</head>
<body>

<div class="container">
  <div class="widget">

    <!-- Header -->
    <div class="header">
      <div class="logo">AI</div>
      <div>
        <div class="title">MBA Counselor</div>
        <div class="subtitle">Tap a topic â€” Explore deeply</div>
      </div>
      <button id="closeBtn" style="margin-left:auto;background:none;border:none;color:var(--muted);cursor:pointer;font-size:18px">âœ•</button>
    </div>

    <!-- Category Chips -->
    <div id="categoryRow" class="top-chips"></div>

    <!-- Conversation -->
    <div class="messages" id="messages"></div>

    <!-- AI Suggested Chips -->
    <div id="subChips" class="sub-chips"></div>

    <!-- Footer Input -->
    <div class="controls">
      <input id="inputMsg" class="input" placeholder="Ask anything..."/>
      <button id="sendBtn" class="send">Send</button>
    </div>

  </div>
</div>

<!-- Lead Modal -->
<div id="leadModal" class="modal-back">
  <div class="modal">
    <h3>Quick Details</h3>
    <p style="color:var(--muted);margin-top:-4px">Weâ€™ll send shortlisted universities to your WhatsApp.</p>

    <div class="field">
      <label>Name</label>
      <input id="leadName" placeholder="Your name"/>
    </div>

    <div class="field">
      <label>WhatsApp Number</label>
      <input id="leadPhone" placeholder="e.g. 9876543210"/>
    </div>

    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:6px">
      <button id="leadCancel" style="border:none;background:none;cursor:pointer;color:var(--muted)">Cancel</button>
      <button id="leadSubmit" class="send">Submit</button>
    </div>

  </div>
</div>

<script>
/* ================== CONFIG ================== */
const BACKEND_URL = "https://chatgpt-widget.onrender.com";     // ðŸ”¥ Change this
const CHAT_URL = BACKEND_URL + "/chat";
const LEAD_URL = BACKEND_URL + "/lead";

/* ================== STATE ================== */
let messages = [];
let awaiting = false;
let lastIntent = null;

/* ================== DOM ================== */
const msgBox = document.getElementById("messages");
const subChips = document.getElementById("subChips");
const categories = document.getElementById("categoryRow");
const input = document.getElementById("inputMsg");
const sendBtn = document.getElementById("sendBtn");

const modal = document.getElementById("leadModal");
const leadName = document.getElementById("leadName");
const leadPhone = document.getElementById("leadPhone");

/* ================== Category Setup ================== */
const CATS = [
  { name: "Online MBA", icon:"ðŸŽ“" },
  { name: "Executive MBA", icon:"ðŸ’¼" },
  { name: "Offline MBA", icon:"ðŸ«" },
  { name: "Study Abroad", icon:"ðŸŒ" },
  { name: "Certifications", icon:"ðŸ“œ" }
];

function renderCategories(){
  categories.innerHTML = "";
  CATS.forEach(cat=>{
    const chip = document.createElement("div");
    chip.className = "cat-chip";
    chip.innerHTML = `<div class='cat-icon'>${cat.icon}</div>${cat.name}`;
    chip.onclick = ()=> handleUser(cat.name, true);
    categories.appendChild(chip);
  });
}

/* ================== Message Rendering ================== */
function addMsg(text,who="bot"){
  const div = document.createElement("div");
  div.className = `msg ${who}`;
  div.innerHTML = `<div>${escape(text)}</div><div class="time">${timestamp()}</div>`;
  msgBox.appendChild(div);
  msgBox.scrollTop = msgBox.scrollHeight;
}
const escape = s => s.replace(/[&<>]/g, m => ({"&":"&amp;","<":"&lt;",">":"&gt;"}[m]));
const timestamp = () => new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});

/* ================== Communication Flow ================== */
async function handleUser(text, forceChip=false){
  if(awaiting) return;
  if(!forceChip && !text.trim()) return;

  addMsg(text,"user");
  messages.push({role:"user",content:text});

  if (/(fee|admission|apply|eligibility|placement|interested)/i.test(text)){
    lastIntent = text;
  }

  awaiting = true;
  addTyping();

  try{
    const res = await fetch(CHAT_URL,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({messages})
    });
    const data = await res.json();
    removeTyping();

    addMsg(data.reply,"bot");
    messages.push({role:"assistant",content:data.reply});

    renderSubchipList(data.chips);
  }
  catch(err){
    removeTyping();
    addMsg("Service error, try again.","bot");
  }
  finally{
    awaiting=false;
  }
}

/* ================== Typing Animation ================== */
function addTyping(){
  const t = document.createElement("div");
  t.className="msg bot";
  t.id="typing";
  t.innerHTML = "<div>Typing...</div>";
  msgBox.appendChild(t);
  msgBox.scrollTop = msgBox.scrollHeight;
}
function removeTyping(){
  const t=document.getElementById("typing");
  if(t) t.remove();
}

/* ================== Dynamic Chips ================== */
function renderSubchipList(list){
  subChips.innerHTML = "";
  (list||[]).forEach(ch=>{
    const c=document.createElement("div");
    c.className="chip";
    c.textContent=ch;

    if(/apply|interested|shortlist/i.test(ch)){
      c.classList.add("primary");
      c.onclick=()=> openModal();
    } 
    else c.onclick=()=> handleUser(ch,true);

    subChips.appendChild(c);
  });
}

/* ================== Lead Modal ================== */
function openModal(){ modal.style.display="flex"; leadName.focus(); }
function closeModal(){ modal.style.display="none"; }

document.getElementById("leadCancel").onclick = ()=>{
  closeModal(); addMsg("Sure. Ask me anything.","bot");
};

document.getElementById("leadSubmit").onclick = async()=>{
  const name = leadName.value.trim();
  const phone = leadPhone.value.trim().replace(/\D/g,'');

  if(!name) return alert("Enter name");
  if(phone.length<10) return alert("Enter valid phone");

  closeModal();
  addMsg(`${name} â€¢ ${phone}`,"user");

  messages.push({ role:"user", content:`Lead: ${name} | ${phone}` });

  addTyping();
  await fetch(LEAD_URL,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      name, phone,
      firstMessage:lastIntent||"",
      conversation:messages,
      timestamp:new Date().toISOString()
    })
  });
  removeTyping();

  addMsg("Thank you! Our counselor will contact you.","bot");
};

/* ================== Send Button ================== */
sendBtn.onclick = ()=>{
  const txt=input.value.trim();
  if(txt) handleUser(txt,false);
  input.value="";
};
input.addEventListener("keypress", e=>{
  if(e.key==="Enter") sendBtn.click();
});

/* ================== Init ================== */
renderCategories();
addMsg("Hi! Choose a category to begin.","bot");

/* ================== Close Button (Wix Lightbox) ================== */
document.getElementById("closeBtn").onclick = ()=>{
  if(window.parent !== window){
    window.parent.postMessage({type:"close-lightbox"},"*");
  }
  document.querySelector(".container").style.display="none";
};
</script>

</body>
</html>
