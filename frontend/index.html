<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>AI MBA Counselor — Enhanced Widget</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap">
<style>
:root{
  --accent:#0b76ff; --accent2:#00c2ff; --bg:#f4f8ff; --muted:#64748b;
  --radius:14px; --shadow:0 18px 48px rgba(8,30,60,0.08);
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial;background:var(--bg);color:#06202a}
.container{display:flex;align-items:center;justify-content:center;height:100vh;padding:18px}
.widget{width:100%;max-width:430px;height:94vh;background:linear-gradient(180deg,#fff,#fbfdff);border-radius:16px;box-shadow:var(--shadow);display:flex;flex-direction:column;overflow:hidden;border:1px solid rgba(11,118,255,0.04)}

/* header */
.header{display:flex;align-items:center;gap:12px;padding:12px 16px;border-bottom:1px solid #eef4fb;background:linear-gradient(90deg, rgba(11,118,255,0.04), transparent)}
.logo{width:46px;height:46px;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700}
.hmeta .title{font-weight:700}
.hmeta .subtitle{font-size:12px;color:var(--muted)}

/* messages */
.messages{flex:1;padding:12px;overflow:auto;display:flex;flex-direction:column;gap:12px;background:linear-gradient(180deg, rgba(255,255,255,0.6), transparent)}
.msg{max-width:82%;padding:12px 14px;border-radius:12px;line-height:1.4;word-break:break-word;box-shadow:0 2px 0 rgba(9,30,60,0.02)}
.msg.bot{background:#f3f4f6;align-self:flex-start}
.msg.user{background:#dff9e1;align-self:flex-end}
.msg .time{font-size:11px;color:var(--muted);margin-top:6px}

/* chips area (wrap, used both for initial categories and later chips) */
.chips-area{display:flex;flex-wrap:wrap;gap:8px;padding:10px 12px;border-top:1px dashed #eef4fb;background:linear-gradient(180deg,transparent,rgba(11,118,255,0.03))}
.chip{padding:8px 12px;border-radius:999px;background:#fff;border:1px solid rgba(11,118,255,0.06);cursor:pointer;box-shadow:0 6px 16px rgba(12,34,75,0.02);transition:transform .12s ease;font-size:13px}
.chip:hover{transform:translateY(-3px)}
.chip.primary{background:var(--accent);color:#fff;border:none;box-shadow:0 12px 30px rgba(11,118,255,0.12)}

/* controls */
.controls{display:flex;gap:8px;padding:12px;border-top:1px solid #eef4fb;background:var(--bg);align-items:center}
.input{flex:1;padding:10px;border-radius:10px;border:1px solid #e6eefc;font-size:14px}
.send{background:var(--accent);color:#fff;padding:10px 14px;border-radius:10px;border:none;cursor:pointer;font-weight:700}

/* modal */
.modal-back{position:fixed;inset:0;background:rgba(2,6,23,0.36);display:none;align-items:center;justify-content:center;z-index:60}
.modal{width:92%;max-width:420px;background:#fff;padding:18px;border-radius:12px;box-shadow:0 20px 60px rgba(8,30,60,0.22)}
.field{display:flex;flex-direction:column;gap:8px;margin-bottom:12px}
.field input{padding:10px;border-radius:8px;border:1px solid #e6eefc;font-size:14px}
.small{font-size:12px;color:var(--muted)}

/* typing */
.typing{display:inline-flex;align-items:center;padding:8px 10px;border-radius:10px;background:#eaf2ff}
.dot{width:6px;height:6px;border-radius:50%;background:#94a3b8;margin:0 3px;opacity:0.7;animation:blink 1s infinite}
@keyframes blink{0%{opacity:0.2}50%{opacity:1}100%{opacity:0.2}}
</style>
</head>
<body>
<div class="container">
  <div class="widget" role="application" aria-label="MBA Counselor chat widget">

    <div class="header">
      <div class="logo">AI</div>
      <div class="hmeta">
        <div class="title">MBA Counselor</div>
        <div class="subtitle">Tap a category or ask — chips come from AI</div>
      </div>
      <button id="close" style="margin-left:auto;border:none;background:transparent;cursor:pointer;color:var(--muted)">✕</button>
    </div>

    <div id="messages" class="messages" aria-live="polite"></div>

    <!-- chips area shared for categories + AI chips -->
    <div id="chipsArea" class="chips-area" aria-hidden="false"></div>

    <div class="controls">
      <input id="inputField" class="input" placeholder="Type (optional) — or tap chips"/>
      <button id="sendBtn" class="send">Send</button>
    </div>
  </div>
</div>

<!-- Lead modal -->
<div id="leadModal" class="modal-back" role="dialog" aria-modal="true">
  <div class="modal">
    <h3>Quick details</h3>
    <p class="small">We'll share shortlisted programs on WhatsApp.</p>
    <div class="field">
      <label>Name</label>
      <input id="leadName" placeholder="Your name"/>
    </div>
    <div class="field">
      <label>WhatsApp number</label>
      <input id="leadPhone" placeholder="e.g. 9876543210"/>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end">
      <button id="leadCancel" style="background:transparent;border:none;cursor:pointer">Cancel</button>
      <button id="leadSubmit" class="send">Submit</button>
    </div>
  </div>
</div>

<script>
/* ================= CONFIG ================= */
const BACKEND_URL = "https://chatgpt-widget.onrender.com"; // <-- set your deployed backend
const CHAT_URL = BACKEND_URL + "/chat";
const LEAD_URL = BACKEND_URL + "/lead";
const STORAGE_KEY = "mba_widget_conversation_v1";

/* ================ STATE ================ */
let messages = [];           // conversation messages (role + content)
let awaiting = false;        // awaiting backend
let lastIntent = null;       // last high-intent message

/* ================ DOM ================ */
const messagesEl = document.getElementById("messages");
const chipsArea = document.getElementById("chipsArea");
const inputField = document.getElementById("inputField");
const sendBtn = document.getElementById("sendBtn");
const leadModal = document.getElementById("leadModal");
const leadName = document.getElementById("leadName");
const leadPhone = document.getElementById("leadPhone");

/* ================ UTILS ================ */
function now(){ return new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}); }
function esc(s){ return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }
function saveState(){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(messages)); }catch(e){} }
function loadState(){ try{ const j = localStorage.getItem(STORAGE_KEY); return j ? JSON.parse(j) : null; }catch(e){ return null; } }

/* ================ MESSAGE RENDER ================ */
function appendBot(text){
  const d = document.createElement("div"); d.className="msg bot";
  d.innerHTML = `<div>${formatReply(text)}</div><div class="time">${now()}</div>`;
  messagesEl.appendChild(d); messagesEl.scrollTop = messagesEl.scrollHeight;
}
function appendUser(text){
  const d = document.createElement("div"); d.className="msg user";
  d.innerHTML = `<div>${esc(text)}</div><div class="time">${now()}</div>`;
  messagesEl.appendChild(d); messagesEl.scrollTop = messagesEl.scrollHeight;
}
function formatReply(text){
  if(!text) return "";
  // If reply contains list markers or newlines, preserve formatting
  if(/\n|^(\d+\)|\d+\.)|^- /m.test(text)){
    // convert newlines to <br> and keep bullets
    const html = esc(text).replace(/\n/g,"<br/>").replace(/\u2022/g,"•");
    return html;
  }
  // short reply: escape normally
  return esc(text);
}

/* typing indicator */
function showTyping(){
  const el = document.createElement("div"); el.className="msg bot"; el.id="typing";
  el.innerHTML = `<div class="typing"><span class="dot"></span><span class="dot"></span><span class="dot"></span></div>`;
  messagesEl.appendChild(el); messagesEl.scrollTop = messagesEl.scrollHeight;
}
function removeTyping(){ const t = document.getElementById("typing"); if(t) t.remove(); }

/* ================ CHIPS ================ */
/* Render chips (provided by backend). If backend returns zero chips, we show a single fallback 'Apply now' chip. */
function renderChips(list){
  chipsArea.innerHTML = "";
  const items = Array.isArray(list) ? list : [];
  items.forEach(text => {
    const el = document.createElement("div");
    el.className = "chip";
    el.textContent = text;
    if(/apply|interested|shortlist/i.test(text)){
      el.classList.add("primary");
      el.onclick = () => openLeadModal();
    } else {
      el.onclick = () => submitUser(text);
    }
    chipsArea.appendChild(el);
  });
  if(items.length === 0){
    const fallback = document.createElement("div");
    fallback.className = "chip primary"; fallback.textContent = "Apply now";
    fallback.onclick = openLeadModal;
    chipsArea.appendChild(fallback);
  }
}

/* ================ INITIAL CATEGORIES ================ */
/* Categories appear below initial bot message as chips — still come from frontend but are the initial choices only */
const INITIAL_CATEGORIES = ["Online MBA","Executive MBA","Offline MBA","Study Abroad","Certifications"];
function showInitialCategories(){
  renderChips(INITIAL_CATEGORIES);
}

/* ================ BACKEND COMMUNICATION ================ */
async function submitUser(text){
  if(awaiting) return;
  appendUser(text);
  messages.push({ role:"user", content:text });
  saveState();

  // check intent keywords (for lead prompts)
  if (/(fee|fees|admission|apply|eligibility|placement|interested|shortlist|list|give list|top colleges)/i.test(text)){
    lastIntent = text;
  }

  awaiting = true;
  showTyping();

  try{
    const res = await fetch(CHAT_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ messages })
    });
    const data = await res.json();
    removeTyping();
    const reply = (data?.reply ?? "Sorry, I couldn't process that.").trim();

    // push assistant message to messages and save
    messages.push({ role:"assistant", content: reply });
    saveState();

    // append reply (format preserves newline/lists)
    appendBot(reply);

    // render chips from backend (dynamic)
    if (Array.isArray(data?.chips)){
      renderChips(data.chips);
    } else {
      // fallback if backend didn't return chips
      renderChips([]);
    }
  }catch(e){
    removeTyping();
    appendBot("Service error. Please try again later.");
    console.error("chat error:", e);
  }finally{
    awaiting = false;
  }
}

/* ================ LEAD MODAL ================ */
function openLeadModal(){ leadModal.style.display = "flex"; leadName.focus(); }
function closeLeadModal(){ leadModal.style.display = "none"; }
document.getElementById("leadCancel").onclick = ()=>{ closeLeadModal(); appendBot("No problem — ask me anything else."); };

document.getElementById("leadSubmit").onclick = async () => {
  const name = leadName.value.trim();
  const phone = (leadPhone.value || "").trim().replace(/\D/g,"");
  if(!name){ alert("Enter your name"); leadName.focus(); return; }
  if(!/^\d{10,15}$/.test(phone)){ alert("Enter valid WhatsApp number"); leadPhone.focus(); return; }

  closeLeadModal();
  appendUser(`${name} • ${phone}`);
  messages.push({ role:"user", content:`Lead: ${name} | ${phone}` });
  saveState();

  showTyping();
  try{
    await fetch(LEAD_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        name, phone, firstMessage: lastIntent || "", conversation: messages, timestamp: new Date().toISOString()
      })
    });
    removeTyping();
    appendBot("Thanks — our counselor will contact you on WhatsApp.");
    messages.push({ role:"assistant", content: "Thanks — our counselor will contact you on WhatsApp." });
    saveState();
    // reset to category chips for fresh flow
    lastIntent = null;
    showInitialCategories();
  }catch(err){
    removeTyping();
    appendBot("Lead submission failed. Try again later.");
    console.error("lead error:", err);
  }
};

/* ================ UI BINDINGS ================ */
sendBtn.onclick = ()=> {
  const text = inputField.value.trim();
  if(!text) return;
  inputField.value = "";
  submitUser(text);
};
inputField.addEventListener("keypress", e => { if(e.key === "Enter") sendBtn.click(); });

document.getElementById("close").onclick = ()=> {
  if(window.parent && window.parent !== window) window.parent.postMessage({ type: "close-lightbox" }, "*");
  else document.querySelector('.container').style.display = 'none';
};

/* ================ Persistence + init ================ */
function restoreConversation(){
  const saved = loadState();
  if(!saved || !Array.isArray(saved) || saved.length === 0){
    // fresh: show greeting + initial categories
    appendBot("Hi! Choose a category to begin.");
    showInitialCategories();
    return;
  }
  messages = saved;
  messages.forEach(m => {
    if(m.role === "user") appendUser(m.content);
    else appendBot(m.content);
  });
  // request fresh chips? show initial categories for context or leave chips blank
  // Best: show categories again so user can pick another flow quickly
  showInitialCategories();
}

/* run */
restoreConversation();
</script>
</body>
</html>
