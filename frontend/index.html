<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>AI Chat Widget — Category Flow</title>
<style>
:root{
  --accent:#0b76ff; --muted:#6b7280; --bg:#f7fbff; --card:#fff;
  --user:#dafbd8; --bot:#f3f4f6; --maxw:420px; --shadow:0 8px 26px rgba(8,30,60,0.08);
  --radius:14px;
}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,system-ui,Arial;background:var(--bg);color:#06202a}
.container{width:100%;height:100vh;display:flex;align-items:center;justify-content:center;padding:16px}
.card{width:100%;max-width:var(--maxw);height:100%;max-height:820px;background:var(--card);border-radius:16px;box-shadow:var(--shadow);display:flex;flex-direction:column;overflow:hidden}

/* header */
.header{display:flex;align-items:center;gap:12px;padding:12px;border-bottom:1px solid #eef4fb;background:linear-gradient(90deg, rgba(11,118,255,0.04), transparent)}
.logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#00c2ff);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700}
.hmeta .title{font-weight:700}
.hmeta .subtitle{font-size:12px;color:var(--muted)}

/* messages */
.messages{flex:1;padding:12px;overflow:auto;display:flex;flex-direction:column;gap:10px;background:linear-gradient(180deg, rgba(255,255,255,0.6), transparent)}
.msg{max-width:82%;padding:12px 14px;border-radius:12px;line-height:1.3;word-break:break-word}
.msg.bot{background:var(--bot);align-self:flex-start}
.msg.user{background:var(--user);align-self:flex-end}
.time{font-size:11px;color:var(--muted);margin-top:6px}

/* chip rows */
.row{display:flex;gap:8px;flex-wrap:wrap;padding:10px 12px;border-top:1px solid #f1f5f9;background:linear-gradient(180deg, rgba(255,255,255,0.5), transparent)}
.chip{padding:8px 12px;border-radius:999px;background:#fff;border:1px solid #eef2f8;cursor:pointer;font-size:13px}
.chip.primary{background:var(--accent);color:#fff;border:none}

/* controls */
.controls{display:flex;gap:8px;padding:12px;border-top:1px solid #eef4fb;align-items:center;background:var(--card)}
.select,input{padding:10px;border-radius:10px;border:1px solid #e6eefc;font-size:14px}
.select{max-width:200px}
.input{flex:1}
.send{background:var(--accent);color:#fff;padding:10px 14px;border-radius:10px;border:none;cursor:pointer;font-weight:700}

/* modal */
.modalBack{position:fixed;inset:0;background:rgba(2,6,23,0.36);display:none;align-items:center;justify-content:center;z-index:50}
.modal{width:92%;max-width:420px;background:#fff;padding:18px;border-radius:12px;box-shadow:var(--shadow)}
.field{display:flex;flex-direction:column;gap:8px;margin-bottom:12px}
.field input{padding:10px;border-radius:8px;border:1px solid #e6eefc}
.modal-actions{display:flex;gap:8px;justify-content:flex-end}
.small{font-size:12px;color:var(--muted)}

/* typing */
.typing{display:inline-flex;align-items:center;padding:8px 10px;border-radius:10px;background:#eaf2ff}
.dot{width:6px;height:6px;border-radius:50%;background:#94a3b8;margin:0 3px;opacity:0.7;animation:blink 1s infinite}
@keyframes blink{0%{opacity:0.3}50%{opacity:1}100%{opacity:0.3}}
</style>
</head>
<body>
<div class="container">
  <div class="card" role="application">

    <!-- header -->
    <div class="header">
      <div class="logo">AI</div>
      <div class="hmeta">
        <div class="title">MBA Counselor</div>
        <div class="subtitle">Choose a category to begin</div>
      </div>
      <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
        <button id="close" style="border:none;background:transparent;cursor:pointer;color:#64748b">✕</button>
      </div>
    </div>

    <!-- messages -->
    <div id="messages" class="messages" aria-live="polite"></div>

    <!-- dynamic chip rows (sub-options) -->
    <div id="chipRow" class="row"></div>

    <!-- controls -->
    <div class="controls">
      <select id="categorySelect" class="select" aria-label="Category select">
        <option value="">— Select category —</option>
        <option value="Executive MBA">Executive MBA</option>
        <option value="Online MBA">Online MBA</option>
        <option value="Offline MBA">Offline MBA</option>
        <option value="Study Abroad">Study Abroad</option>
        <option value="Certifications">Certifications</option>
      </select>

      <input id="input" class="input" placeholder="Or type your question..." aria-label="Message input"/>
      <button id="send" class="send">Send</button>
    </div>

    <div style="padding:10px 14px;border-top:1px solid #f1f5f9;text-align:center;font-size:12px;color:var(--muted)">Short replies (1–5 words). <a href="#" style="color:var(--accent)">Privacy</a></div>
  </div>
</div>

<!-- Lead modal -->
<div id="leadModal" class="modalBack" role="dialog" aria-modal="true">
  <div class="modal">
    <h3>Share your details</h3>
    <p class="small">We will send shortlisted programs to your WhatsApp.</p>
    <div class="field">
      <label>Name</label>
      <input id="leadName" type="text" placeholder="Your name" />
    </div>
    <div class="field">
      <label>WhatsApp number</label>
      <input id="leadPhone" type="tel" placeholder="e.g., 9876543210" />
    </div>
    <div class="modal-actions">
      <button id="leadCancel" style="background:transparent;border:none;cursor:pointer">Cancel</button>
      <button id="leadSubmit" class="send">Submit</button>
    </div>
  </div>
</div>

<script>
/* ====== CONFIG ====== */
const BACKEND_URL = "https://chatgpt-widget.onrender.com"; // <-- set your backend base URL (no trailing slash)
const CHAT_ENDPOINT = BACKEND_URL + "/chat";
const LEAD_ENDPOINT = BACKEND_URL + "/lead";

/* ====== STATE ====== */
let messages = [];
let awaiting = false;
let pendingCategory = null;   // currently chosen category
let pendingSuboptions = [];   // visible suboptions for category
let highIntent = false;
let lastIntentText = null;

/* ====== UI REFS ====== */
const messagesEl = document.getElementById("messages");
const chipRow = document.getElementById("chipRow");
const categorySelect = document.getElementById("categorySelect");
const inputEl = document.getElementById("input");
const sendBtn = document.getElementById("send");
const leadModal = document.getElementById("leadModal");
const leadName = document.getElementById("leadName");
const leadPhone = document.getElementById("leadPhone");
const leadSubmit = document.getElementById("leadSubmit");
const leadCancel = document.getElementById("leadCancel");

/* ====== UTILS ====== */
function now(){ return new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}); }
function esc(s){ return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }
function appendUser(t){
  const div = document.createElement("div");
  div.className = "msg user";
  div.innerHTML = `<div>${esc(t)}</div><div class="time">${now()}</div>`;
  messagesEl.appendChild(div);
  messagesEl.scrollTop = messagesEl.scrollHeight;
}
function appendBot(t){
  const div = document.createElement("div");
  div.className = "msg bot";
  div.innerHTML = `<div>${esc(t)}</div><div class="time">${now()}</div>`;
  messagesEl.appendChild(div);
  messagesEl.scrollTop = messagesEl.scrollHeight;
}
function showTyping(){
  const el = document.createElement("div");
  el.id = "typing";
  el.className = "msg bot";
  el.innerHTML = `<div class="typing"><span class="dot"></span><span class="dot"></span><span class="dot"></span></div>`;
  messagesEl.appendChild(el); messagesEl.scrollTop = messagesEl.scrollHeight;
}
function removeTyping(){ const t = document.getElementById("typing"); if(t) t.remove(); }

/* ====== Category → suboptions map ====== */
const SUB_OPTIONS = {
  "Executive MBA": ["Part-time", "Weekend batches", "Top colleges", "Fees range", "Admission"],
  "Online MBA": ["1-year program", "2-year program", "Top online colleges", "Fees range", "Scholarships"],
  "Offline MBA": ["Full-time", "Part-time", "Top offline colleges", "Placements", "Fees"],
  "Study Abroad": ["Top countries", "Cost estimate", "Scholarships", "Admission process", "Eligibility"],
  "Certifications": ["Analytics", "Finance", "Digital Marketing", "Duration", "Value"]
};

/* ====== Quick chips initial ====== */
const DEFAULT_CHIPS = ["Fees?","Eligibility?","Best MBA?","Placement?","Apply now"];
function renderDefaultChips(){ renderChips(DEFAULT_CHIPS); }

/* ====== render chips helper ====== */
function renderChips(list){
  chipRow.innerHTML = "";
  list.forEach(text=>{
    const el = document.createElement("div");
    el.className = "chip";
    el.textContent = text;
    el.onclick = ()=>onChipClick(text);
    chipRow.appendChild(el);
  });
}

/* ====== handle chip click ====== */
function onChipClick(text){
  // Apply/Interested triggers lead modal immediately
  if(/apply|interested|contact/i.test(text)){
    openLeadModal();
    return;
  }
  // If chip matches a category name, select it
  if(SUB_OPTIONS[text]){
    handleCategorySelect(text);
    return;
  }
  // else normal message
  handleUserMessage(text);
}

/* ====== detect high-intent keywords ====== */
const INTENT_K = ["fee","fees","admission","apply","eligibility","scholarship","placement","interested","contact"];
function detectIntent(txt){
  const s = txt.toLowerCase();
  return INTENT_K.some(k => s.includes(k));
}

/* ====== main send to chat ====== */
async function sendToChat(){
  if(awaiting) return;
  awaiting = true; disableControls(true);
  showTyping();
  try{
    const res = await fetch(CHAT_ENDPOINT, {
      method: "POST", headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ messages })
    });
    if(!res.ok) throw new Error("chat failed "+res.status);
    const data = await res.json();
    removeTyping();
    const reply = (data.reply || "Sorry, try again").trim();
    appendBot(reply);
    messages.push({ role:"assistant", content: reply });

    // if earlier message had high intent, show soft CTA chips after reply
    if(highIntent){
      setTimeout(()=> {
        // add soft CTA chips
        const cInterested = document.createElement("div");
        cInterested.className = "chip primary";
        cInterested.textContent = "Interested?";
        cInterested.onclick = openLeadModal;
        const cApply = document.createElement("div");
        cApply.className = "chip";
        cApply.textContent = "Apply now";
        cApply.onclick = openLeadModal;
        chipRow.prepend(cApply); chipRow.prepend(cInterested);
      }, 350);
    }
  }catch(err){
    removeTyping();
    appendBot("Service error. Try again later.");
    console.error(err);
  }finally{
    awaiting = false; disableControls(false);
  }
}

/* ====== user message handling ====== */
async function handleUserMessage(text){
  if(!text) return;
  appendUser(text);
  messages.push({ role:"user", content: text });

  // detect intent -> mark but do NOT open lead modal now
  if(detectIntent(text)){
    highIntent = true;
    lastIntentText = text;
  }

  await sendToChat();
}

/* ====== category select handling ====== */
function handleCategorySelect(category){
  pendingCategory = category;
  // show immediate user message that user selected category
  appendUser(category);
  messages.push({ role:"user", content: category });
  // render suboptions for that category
  const subs = SUB_OPTIONS[category] || [];
  renderChips(subs);
  // Also send the category as a message to AI to provide initial guidance
  // This will allow the AI to respond and then present deeper follow-ups
  highIntent = false; // selecting category is exploratory, not conversion
  sendToChat(); // sends current messages including category selection
}

/* ====== controls & bindings ====== */
sendBtn.addEventListener("click", ()=> {
  const v = inputEl.value.trim(); if(!v) return; inputEl.value = "";
  handleUserMessage(v);
});
inputEl.addEventListener("keypress", e=> { if(e.key === "Enter") sendBtn.click(); });
categorySelect.addEventListener("change", ()=> {
  const v = categorySelect.value; if(!v) return; categorySelect.value = "";
  handleCategorySelect(v);
});
document.getElementById("close").addEventListener("click", ()=> {
  // if embedded in iframe, post message to parent (Wix Lightbox will close)
  if(window.parent && window.parent !== window) window.parent.postMessage({type:"close-lightbox"}, "*");
  else document.querySelector('.container').style.display = 'none';
});

/* ====== lead modal logic ====== */
function openLeadModal(){ leadName.value=''; leadPhone.value=''; leadModal.style.display='flex'; leadName.focus(); }
function closeLeadModal(){ leadModal.style.display='none'; }

leadCancel.addEventListener("click", ()=> { closeLeadModal(); appendBot("No worries — ask me anything else."); });
leadSubmit.addEventListener("click", async ()=>{
  const name = (leadName.value||"").trim(); const phone = (leadPhone.value||"").trim().replace(/\D/g,'');
  if(!name){ alert("Enter your name"); leadName.focus(); return; }
  if(!/^\d{10,15}$/.test(phone)){ alert("Enter valid phone (digits)"); leadPhone.focus(); return; }

  closeLeadModal();
  appendUser(`${name} • ${phone}`);
  messages.push({ role:"user", content: `Lead: ${name} | ${phone}` });

  // send to backend lead proxy
  try{
    awaiting = true; disableControls(true); showTyping();
    const payload = { name, phone, firstMessage: lastIntentText || "", conversation: messages, timestamp: new Date().toISOString() };
    const r = await fetch(LEAD_ENDPOINT, { method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify(payload) });
    removeTyping();
    if(!r.ok) throw new Error("lead failed "+r.status);
    appendBot("Thanks! Our counselor will contact you.");
    messages.push({ role:"assistant", content:"Thanks! Our counselor will contact you." });
    // reset intent
    highIntent = false; lastIntentText = null; renderDefaultChips();
  }catch(err){
    removeTyping();
    appendBot("Lead submission failed. Try again later.");
    console.error(err);
  }finally{ awaiting=false; disableControls(false); }
});

/* ====== enable/disable controls ====== */
function disableControls(b){ inputEl.disabled=b; sendBtn.disabled=b; categorySelect.disabled=b; Array.from(document.getElementsByClassName("chip")).forEach(c=> c.style.pointerEvents = b ? "none" : "auto"); }

/* ====== initial UI ====== */
appendBot("Hi! Choose a category to start or type your question.");
appendBot("I'll give short answers and one follow-up.");
renderDefaultChips();

/* ====== debug helper (optional) ====== */
window._widgetState = ()=> ({ messages, highIntent });
</script>
</body>
</html>
