<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>AI MBA Counselor</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap">
<style>
:root{
  --bg: #f8f9fc;
  --chat-bg: #ffffff;
  --user-bg: #0b76ff;
  --bot-bg: #f1f3f5;
  --accent: #0b76ff;
  --text: #1e293b;
  --muted: #64748b;
  --radius: 16px;
  --shadow: 0 10px 30px rgba(0,0,0,0.06);
}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--text);height:100vh;display:flex;align-items:center;justify-content:center;padding:16px}
.widget{width:100%;max-width:460px;height:94vh;background:var(--chat-bg);border-radius:var(--radius);box-shadow:var(--shadow);display:flex;flex-direction:column;overflow:hidden;border:1px solid #e2e8f0}
.header{padding:14px 20px;border-bottom:1px solid #e2e8f0;background:var(--chat-bg);text-align:center;font-weight:600;font-size:17px;position:relative;display:flex;align-items:center;justify-content:center;gap:8px}
.header .title{flex:1;text-align:center}
.header .brand{position:absolute;left:14px;top:50%;transform:translateY(-50%);font-size:13px;color:var(--muted)}
.messages{flex:1;overflow-y:auto;padding:20px;display:flex;flex-direction:column;gap:18px}
.msg{max-width:86%;line-height:1.5;padding:12px 16px;border-radius:16px;animation:fadeIn .25s ease;font-size:15px;word-break:break-word}
.msg.user{align-self:flex-end;background:var(--user-bg);color:#fff;border-bottom-right-radius:4px}
.msg.bot{align-self:flex-start;background:var(--bot-bg);border-bottom-left-radius:4px}
.tile{background:#fff;border:1px solid #e2e8f0;border-radius:14px;padding:16px;margin:12px 0;box-shadow:0 4px 12px rgba(0,0,0,0.04);transition:all .2s;cursor:pointer}
.tile:hover{transform:translateY(-4px);box-shadow:0 12px 30px rgba(0,0,0,0.1)}
.tile-title{font-weight:600;font-size:16px;margin-bottom:6px}
.tile-subtitle{font-size:13px;color:var(--muted);margin-bottom:10px}
.tile-tags{display:flex;flex-wrap:wrap;gap:6px;margin:10px 0}
.tag{background:#e0f2fe;color:#0369a1;padding:4px 10px;border-radius:999px;font-size:11px;font-weight:500}
.tile-action{margin-top:12px;padding:10px 16px;background:var(--accent);color:#fff;border:none;border-radius:10px;font-weight:600;cursor:pointer;width:100%}
.chips-area{padding:12px 20px;display:none;flex-wrap:wrap;gap:10px;background:var(--chat-bg);border-top:1px solid #e2e8f0}
.chip{padding:10px 16px;background:#f1f5f9;border-radius:999px;font-size:14px;cursor:pointer;transition:all .15s;user-select:none}
.chip:hover{transform:translateY(-3px);background:#e2e8f0}
.chip.primary{background:var(--accent);color:#fff}
.input-area{padding:16px 20px;background:var(--chat-bg);border-top:1px solid #e2e8f0;display:flex;gap:12px;align-items:center}
#inputField{flex:1;padding:14px 18px;border:1px solid #cbd5e1;border-radius:12px;font-size:15px;outline:none}
#inputField:focus{border-color:var(--accent)}
#sendBtn{background:var(--accent);color:#fff;border:none;width:44px;height:44px;border-radius:50%;cursor:pointer;font-size:18px}
.typing{display:inline-flex;gap:4px;align-items:center}
.dot{width:8px;height:8px;background:#94a3b8;border-radius:50%;animation:blink 1.4s infinite both}
.dot:nth-child(2){animation-delay:.2s}
.dot:nth-child(3){animation-delay:.4s}
@keyframes blink{0%,80%,100%{opacity:.3;transform:scale(.8)}40%{opacity:1;transform:scale(1)}}
@keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
.modal-back{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:none;align-items:center;justify-content:center;z-index:100}
.modal{background:#fff;width:90%;max-width:420px;border-radius:12px;padding:20px;text-align:center;box-shadow:var(--shadow)}
.modal h3{margin-bottom:8px;font-size:18px}
.modal p{color:var(--muted);margin:10px 0 16px;font-size:14px}
.modal input{width:100%;padding:14px;margin:8px 0;border:1px solid #cbd5e1;border-radius:10px;font-size:15px}
.modal .controls{display:flex;gap:12px;justify-content:center;margin-top:12px}
.modal button{padding:10px 16px;border:none;border-radius:10px;cursor:pointer}
.modal .cancel{background:#e6e6e6;color:#111827}
.modal .primary{background:var(--accent);color:#fff;font-weight:600}
.footer-powered{padding:8px 12px;text-align:center;font-size:12px;color:var(--muted);border-top:1px solid #f1f5f9;background:transparent}
</style>
</head>
<body>

<div class="widget" role="application" aria-label="MBA Counselor widget">
  <div class="header">
    <div class="brand">AI</div>
    <div class="title">AI MBA Counselor</div>
  </div>

  <div id="messages" class="messages" aria-live="polite"></div>
  <div id="chipsArea" class="chips-area" aria-hidden="true"></div>

  <div class="input-area" role="group" aria-label="chat input">
    <input id="inputField" placeholder="Ask about MBA, fees, colleges..." autocomplete="off" aria-label="Type a message"/>
    <button id="sendBtn" aria-label="Send message">↑</button>
  </div>

  <div class="footer-powered">Powered by ChatGPT</div>
</div>

<!-- Lead Modal -->
<div id="leadModal" class="modal-back" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="modal">
    <h3>Get a callback</h3>
    <p>We’ll reach out to guide you further.</p>
    <input id="leadName" placeholder="Your full name" aria-label="Your full name"/>
    <input id="leadPhone" placeholder="Phone number" inputmode="numeric" aria-label="Phone number"/>
    <div class="controls">
      <button class="cancel" onclick="closeLeadModal()">Cancel</button>
      <button class="primary" id="leadSubmit">Send</button>
    </div>
  </div>
</div>

<script>
const BACKEND_URL = "https://chatgpt-widget.onrender.com";
const CHAT_URL = BACKEND_URL + "/chat";
const LEAD_URL = BACKEND_URL + "/lead";
const STORAGE_KEY = "mba_chat_v2";

let messages = [];
let awaiting = false;
let lastIntent = null;

const msgs = document.getElementById("messages");
const chipsArea = document.getElementById("chipsArea");
const inputField = document.getElementById("inputField");
const sendBtn = document.getElementById("sendBtn");

function showChipsContainer() {
  chipsArea.style.display = "flex";
  chipsArea.setAttribute("aria-hidden", "false");
}
function hideChipsContainer() {
  chipsArea.innerHTML = "";
  chipsArea.style.display = "none";
  chipsArea.setAttribute("aria-hidden", "true");
}

// Helpers
function scrollToBottom() { msgs.scrollTop = msgs.scrollHeight; }
function escapeHtml(text) { const d = document.createElement('div'); d.textContent = text; return d.innerHTML; }

function appendUser(text) {
  const div = document.createElement("div");
  div.className = "msg user";
  div.innerHTML = escapeHtml(text);
  msgs.appendChild(div);
  scrollToBottom();
}

function appendBot(html) {
  const div = document.createElement("div");
  div.className = "msg bot";
  div.innerHTML = html;
  msgs.appendChild(div);
  scrollToBottom();
}

function renderTiles(tiles) {
  tiles.forEach(tile => {
    const t = document.createElement("div");
    t.className = "tile";
    const tagsHtml = tile.tags && Array.isArray(tile.tags)
      ? `<div class="tile-tags">${tile.tags.map(tag => `<span class="tag">${escapeHtml(tag)}</span>`).join('')}</div>`
      : '';
    t.innerHTML = `
      <div class="tile-title">${escapeHtml(tile.title || tile.name || '')}</div>
      <div class="tile-subtitle">${escapeHtml(tile.subtitle || '')}</div>
      ${tagsHtml}
      <button class="tile-action" onclick="handleTileAction('${escapeHtml(tile.actionChip || 'Shortlist me')}')">
        ${escapeHtml(tile.actionChip || 'Shortlist me')}
      </button>
    `;
    msgs.appendChild(t);
  });
  scrollToBottom();
}

// Chip rendering logic: only show relevant chips, hide otherwise
function renderChips(chipsFromServer, lastReplyText) {
  let chips = Array.isArray(chipsFromServer)
    ? chipsFromServer.map(c => String(c).trim()).filter(Boolean)
    : [];

  const buildFallback = (reply) => {
    const fallback = [];
    const r = (reply || "").toLowerCase();
    if (/fee|cost|₹|scholar/.test(r)) fallback.push("Fees?", "Scholarship options");
    if (/college|top mba|list/.test(r)) fallback.push("Top colleges", "Shortlist me");
    if (/eligib|requirement/.test(r)) fallback.push("Eligibility", "Apply now");
    if (!fallback.length) fallback.push("Top colleges", "Fees?", "Shortlist me");
    return fallback;
  };

  if (!chips.length) {
    chips = buildFallback(lastReplyText);
  }

  const yesNoPattern = /(would you like|want more|need more|do you want|yes or no|apply now\?|interested\?)/i;
  const endsWithQuestion = /\?\s*$/.test((lastReplyText || "").trim());

  if ((lastReplyText && yesNoPattern.test(lastReplyText)) || endsWithQuestion) {
    if (!chips.some(c => /^yes$/i.test(c))) chips.unshift("Yes");
    if (!chips.some(c => /^no$/i.test(c))) {
      const yesIndex = chips.findIndex(c => /^yes$/i.test(c));
      chips.splice(yesIndex + 1, 0, "No");
    }
  }

  chips = chips.map(c => c.split(/\s+/).slice(0,4).join(' ')).slice(0,6);

  if (!chips.length) {
    hideChipsContainer();
    return;
  }

  showChipsContainer();
  chipsArea.innerHTML = "";
  chips.forEach(text => {
    const chip = document.createElement("div");
    const isConversion = /(apply|shortlist|interested|contact|call|enrol)/i.test(text);
    chip.className = "chip" + (isConversion ? " primary" : "");
    chip.textContent = text;
    chip.onclick = () => isConversion ? openLeadModal() : submit(text);
    chipsArea.appendChild(chip);
  });
}

// Typing indicator
function showTyping() {
  const t = document.createElement("div");
  t.className = "msg bot";
  t.id = "typing";
  t.innerHTML = `<div class="typing" aria-hidden="true"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>`;
  msgs.appendChild(t);
  scrollToBottom();
}
function removeTyping() {
  const t = document.getElementById("typing");
  if (t) t.remove();
}

// Submit user message
async function submit(text) {
  if (awaiting || !text || !text.trim()) return;
  const userMsg = text.trim();
  appendUser(userMsg);
  inputField.value = "";
  messages.push({ role: "user", content: userMsg });

  if (/(fee|apply|shortlist|interested|eligibility|placement)/i.test(userMsg)) lastIntent = userMsg;

  awaiting = true;
  showTyping();

  try {
    const res = await fetch(CHAT_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ messages })
    });
    if (!res.ok) throw new Error("Network response not ok");

    const data = await res.json();
    removeTyping();

    const reply = data?.reply ? data.reply.toString().trim() : "Let me help you with that.";
    messages.push({ role: "assistant", content: reply });
    appendBot(escapeHtml(reply).replace(/\n/g, "<br>"));

    if (data?.tiles?.length) renderTiles(data.tiles);
    renderChips(data?.chips || [], reply);
  } catch (err) {
    removeTyping();
    appendBot("Sorry, I'm having trouble connecting. Try again.");
    renderChips([], "");
  } finally {
    awaiting = false;
  }
}

// Lead modal logic
function openLeadModal() {
  const modal = document.getElementById("leadModal");
  modal.style.display = "flex";
  modal.setAttribute("aria-hidden", "false");
  document.getElementById("leadName").focus();
}
function closeLeadModal() {
  const modal = document.getElementById("leadModal");
  modal.style.display = "none";
  modal.setAttribute("aria-hidden", "true");
}

document.getElementById("leadSubmit").onclick = async () => {
  const name = document.getElementById("leadName").value.trim();
  const phone = document.getElementById("leadPhone").value.replace(/\D/g, "");
  if (!name || phone.length < 10) {
    alert("Please enter name and a valid phone number");
    return;
  }
  closeLeadModal();
  appendBot("Thanks! We’ll reach out to assist you shortly.");
  hideChipsContainer();

  try {
    await fetch(LEAD_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        name,
        phone,
        firstMessage: messages.find(m => m.role === 'user')?.content || "",
        conversation: messages,
        timestamp: new Date().toISOString(),
        lastIntent
      })
    });
  } catch (e) {
    console.warn("Lead POST failed", e);
  }
};

// Input handlers
sendBtn.onclick = () => submit(inputField.value);
inputField.addEventListener("keypress", e => { if (e.key === "Enter") submit(inputField.value); });

// Initial state
messages = [];
msgs.innerHTML = "";
appendBot("Hi! I'm your MBA counselor for working professionals in India.<br>Tap a topic below to get started.");
renderChips(["Online MBA", "Executive MBA", "Offline MBA", "Study Abroad", "Certifications"]);

// Tile action handler
function handleTileAction(action) {
  if (/(shortlist|apply|interested)/i.test(action)) openLeadModal();
  else submit(action);
}
</script>
</body>
</html>